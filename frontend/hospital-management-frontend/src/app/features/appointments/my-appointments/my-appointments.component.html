<div class="appointments-container">
  <div class="appointments-header">
    <div class="header-content">
      <h1>My Appointments</h1>
      <button class="book-appointment-btn" (click)="bookNewAppointment()">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Book New Appointment
      </button>
    </div>
    <!-- <div class="appointment-stats">
      <div class="stat-card upcoming">
        <div class="stat-number">{{ appointmentStats.totalUpcoming }}</div>
        <div class="stat-label">Upcoming</div>
      </div>
      <div class="stat-card past">
        <div class="stat-number">{{ appointmentStats.totalPast }}</div>
        <div class="stat-label">Past</div>
      </div>
    </div> -->
  </div>

  <div class="appointments-tabs">
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'upcoming'"
      (click)="setActiveTab('upcoming')"
    >
      Upcoming Appointments
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'past'"
      (click)="setActiveTab('past')"
    >
      Past Appointments
    </button>
  </div>

  <div class="appointments-content">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading appointments...</p>
    </div>

    <!-- Appointments Table -->
    <div *ngIf="!isLoading && appointments.length > 0" class="appointments-table-container">
      <div class="table-controls">
        <div class="filter-controls">
          <select [(ngModel)]="statusFilter" (change)="onStatusFilterChange()" class="filter-select">
            <option value="">All Statuses</option>
            <option value="SCHEDULED">Scheduled</option>
            <option value="COMPLETED">Completed</option>
            <option value="CANCELLED" *ngIf="activeTab === 'past'">Cancelled</option>
          </select>
          <select [(ngModel)]="pageSize" (change)="onPageSizeChange(pageSize)" class="filter-select">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }} per page</option>
          </select>
        </div>
      </div>

      <!-- Table Container -->
      <div class="table-container">
        <table class="appointments-table">
          <thead>
            <tr>
              <th class="sortable" (click)="onSortChange('appointmentDate')">
                Date
                <span class="sort-indicator" *ngIf="sortBy === 'appointmentDate'">
                  {{ sortDir === 'asc' ? 'â†‘' : 'â†“' }}
                </span>
              </th>
              <th class="sortable" (click)="onSortChange('appointmentTime')">
                Time
                <span class="sort-indicator" *ngIf="sortBy === 'appointmentTime'">
                  {{ sortDir === 'asc' ? 'â†‘' : 'â†“' }}
                </span>
              </th>
              <th>Doctor</th>
              <th class="sortable" (click)="onSortChange('appointmentType')">
                Type
                <span class="sort-indicator" *ngIf="sortBy === 'appointmentType'">
                  {{ sortDir === 'asc' ? 'â†‘' : 'â†“' }}
                </span>
              </th>
              <th class="sortable" (click)="onSortChange('status')">
                Status
                <span class="sort-indicator" *ngIf="sortBy === 'status'">
                  {{ sortDir === 'asc' ? 'â†‘' : 'â†“' }}
                </span>
              </th>
              <th>Fee</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let appointment of appointments" class="appointment-row">
              <td class="appointment-date-cell">
                <div class="appointment-date">{{ formatDate(appointment.appointmentDate) }}</div>
                <div class="appointment-day">{{ getDayOfWeek(appointment.appointmentDate) }}</div>
              </td>
              <td class="appointment-time-cell">
                <div class="appointment-time">{{ formatTime(appointment.appointmentTime) }}</div>
                <div class="appointment-end-time">{{ formatTime(appointment.endTime) }}</div>
              </td>
              <td class="doctor-cell">
                <div class="doctor-name">{{ getDoctorName(appointment.doctor) || 'Dr. Unknown' }}</div>
                <div class="doctor-specialization">{{ appointment.doctor.specialization.name || 'General' }}</div>
              </td>
              <td class="appointment-type-cell">
                <span class="appointment-type">{{ appointment.appointmentType }}</span>
              </td>
              <td class="appointment-status-cell">
                <span class="appointment-status" [ngClass]="'status-' + appointment.status.toLowerCase()">
                  {{ appointment.status }}
                </span>
              </td>
              <td class="appointment-fee-cell">
                <span class="appointment-fee">â‚¹{{ appointment.consultationFee }}</span>
              </td>
              <td class="appointment-actions-cell">
                <div class="appointment-actions">
                  <button class="btn-primary btn-sm" (click)="viewAppointment(appointment)" title="View Details">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                  </button>
                  <div *ngIf="shouldShowActions(appointment)">
                    <button class="btn-secondary btn-sm" (click)="rescheduleAppointment(appointment)" title="Reschedule">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                      </svg>
                    </button>
                    <button class="btn-danger btn-sm" (click)="cancelAppointment(appointment)" title="Cancel">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls -->
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ (currentPage * pageSize) + 1 }} to {{ Math.min((currentPage + 1) * pageSize, totalElements) }} of {{ totalElements }} appointments
        </div>
        <div class="pagination-controls">
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === 0" 
            (click)="onPageChange(0)"
            title="First Page"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="11 17 6 12 11 7"/>
              <polyline points="18 17 13 12 18 7"/>
            </svg>
          </button>
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === 0" 
            (click)="onPageChange(currentPage - 1)"
            title="Previous Page"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          
          <div class="page-numbers">
            <button 
              *ngFor="let page of getPageNumbers()" 
              class="pagination-btn page-number"
              [class.active]="page === currentPage"
              (click)="onPageChange(page)"
            >
              {{ page + 1 }}
            </button>
          </div>
          
          <button 
            class="pagination-btn" 
            [disabled]="currentPage >= totalPages - 1" 
            (click)="onPageChange(currentPage + 1)"
            title="Next Page"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
          <button 
            class="pagination-btn" 
            [disabled]="currentPage >= totalPages - 1" 
            (click)="onPageChange(totalPages - 1)"
            title="Last Page"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="13 17 18 12 13 7"/>
              <polyline points="6 17 11 12 6 7"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && appointments.length === 0" class="empty-state">
      <div class="empty-icon">ðŸ“…</div>
      <h3 *ngIf="!hasFilteredResults && statusFilter">No {{ statusFilter.toLowerCase() }} appointments found</h3>
      <h3 *ngIf="!hasFilteredResults && !statusFilter">No {{ activeTab }} appointments found</h3>
      <h3 *ngIf="hasFilteredResults">No appointments found</h3>
      <p *ngIf="!hasFilteredResults && statusFilter">Try selecting a different status or clear the filter.</p>
      <p *ngIf="!hasFilteredResults && !statusFilter">You don't have any {{ activeTab }} appointments.</p>
      <p *ngIf="hasFilteredResults">You don't have any appointments matching your current filters.</p>
      <div class="empty-state-actions">
        <button class="btn-secondary" (click)="statusFilter = ''; onStatusFilterChange()" *ngIf="statusFilter">
          Clear Filter
        </button>
        <button class="btn-primary" (click)="bookNewAppointment()" *ngIf="activeTab === 'upcoming'">
          Book New Appointment
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Reschedule Modal -->
<div *ngIf="showRescheduleModal" class="modal-overlay" (click)="closeRescheduleModal()">
  <div class="modal-content reschedule-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Reschedule Appointment</h3>
      <button class="modal-close" (click)="closeRescheduleModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="reschedule-info">
        <p><strong>Doctor:</strong> {{ getDoctorName(selectedAppointment?.doctor) }}</p>
        <p><strong>Current Date:</strong> {{ selectedAppointment?.appointmentDate }}</p>
        <p><strong>Current Time:</strong> {{ selectedAppointment?.appointmentTime }} - {{ selectedAppointment?.endTime }}</p>
      </div>
      
      <div class="form-group">
        <label>Select New Date:</label>
        <input type="date" [(ngModel)]="rescheduleData.appointmentDate" [min]="today" (change)="onRescheduleDateChange()">
      </div>
      
      <div class="available-slots" *ngIf="availableSlots.length > 0">
        <h4>Available Time Slots:</h4>
        <div class="slots-grid">
          <div 
            *ngFor="let slot of availableSlots" 
            class="slot-card"
            [class.selected]="selectedSlot?.slotId === slot.slotId"
            (click)="selectSlot(slot)">
            <div class="slot-time">{{ slot.startTime }} - {{ slot.endTime }}</div>
            <div class="slot-status">{{ slot.status }}</div>
          </div>
        </div>
      </div>
      
      <div class="no-slots" *ngIf="rescheduleData.appointmentDate && availableSlots.length === 0 && !isLoadingSlots">
        <p>No available slots for this date. Please select a different date.</p>
      </div>
      
      <div class="loading-slots" *ngIf="isLoadingSlots">
        <p>Loading available slots...</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeRescheduleModal()">Cancel</button>
      <button 
        class="btn-primary" 
        (click)="confirmReschedule()" 
        [disabled]="!rescheduleData.appointmentDate || !selectedSlot">
        Reschedule
      </button>
    </div>
  </div>
</div>

<!-- Cancel Modal -->
<div *ngIf="showCancelModal" class="modal-overlay" (click)="closeCancelModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Cancel Appointment</h3>
      <button class="modal-close" (click)="closeCancelModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Reason for cancellation:</label>
        <textarea [(ngModel)]="cancelReason" placeholder="Please provide a reason for cancelling this appointment..." rows="3"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeCancelModal()">Keep Appointment</button>
      <button class="btn-danger" (click)="confirmCancel()" [disabled]="!cancelReason.trim()">
        Cancel Appointment
      </button>
    </div>
  </div>
</div>

<!-- Appointment Details Modal -->
<app-appointment-details-modal
  [appointmentId]="selectedAppointmentId"
  [showModal]="showAppointmentDetailsModal"
  [userRole]="'PATIENT'"
  (closeModal)="onCloseAppointmentDetailsModal()"
  (appointmentCancelled)="onAppointmentCancelled()">
</app-appointment-details-modal>